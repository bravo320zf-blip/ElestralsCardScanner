<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Death Forge: Elestrals Legend Tracker</title>
    <style>
        :root { 
            --gold: #d4af37; --midnight: #0a0e14; --card-bg: #151a21; 
            --glow: rgba(212, 175, 55, 0.3); --accent-blue: #00d4ff;
        }

        body { 
            margin: 0; font-family: 'Segoe UI', serif; 
            background-color: var(--midnight); color: #e0e0e0; 
            overflow-x: hidden;
        }

        /* Fixed Navigation */
        nav { 
            display: flex; justify-content: space-around; background: rgba(0,0,0,0.9); 
            padding: 15px 0; position: sticky; top: 0; z-index: 100; border-bottom: 2px solid var(--gold);
        }
        nav span { cursor: pointer; font-weight: bold; color: #888; text-transform: uppercase; }
        nav span.active { color: var(--gold); text-shadow: 0 0 10px var(--gold); }

        .view { display: none; padding: 15px; box-sizing: border-box; }
        .view.active { display: block; }

        /* Fixed Search & Filters */
        .search-container {
            position: sticky; top: 60px; background: var(--midnight);
            padding: 10px 0; z-index: 90; margin-bottom: 15px;
        }
        #search { 
            width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid var(--gold); 
            color: white; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px;
        }
        .filter-scroll { 
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; 
            -webkit-overflow-scrolling: touch; 
        }
        .chip { 
            background: #222; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; 
            white-space: nowrap; cursor: pointer; border: 1px solid #444; 
        }
        .chip.active { background: var(--gold); color: black; font-weight: bold; }

        /* Grid & Cards */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 12px; }
        .card-item { 
            background: var(--card-bg); border-radius: 10px; padding: 8px; text-align: center; 
            border: 1px solid #333; pointer-events: auto;
        }
        .card-item img { width: 100%; border-radius: 5px; pointer-events: none; }

        /* Detail Modal */
        #detail-view { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--midnight); z-index: 200; display: none; padding: 20px; box-sizing: border-box;
        }
        .detail-img { width: 100%; max-width: 300px; display: block; margin: 0 auto 20px; border-radius: 15px; box-shadow: 0 0 20px var(--gold); }
    </style>
</head>
<body>

    <nav>
        <span id="nav-scan" class="active" onclick="showView('scan')">Summon</span>
        <span id="nav-collection" onclick="showView('collection')">Vault</span>
    </nav>

    <div id="view-scan" class="view active">
        <div style="text-align:center; padding: 50px 20px; border: 2px dashed #444; border-radius: 15px;">
            <p>Scanner Active</p>
            <button onclick="mockScan()" style="padding:15px; background:var(--gold); border:none; font-weight:bold; border-radius:10px;">MOCK SCAN (ADRESTIA)</button>
        </div>
    </div>

    <div id="view-collection" class="view">
        <div class="search-container">
            <input type="text" id="search" placeholder="Search by name..." oninput="renderVault()">
            <div class="filter-scroll">
                <div class="chip active" onclick="setFilter('All', this)">All</div>
                <div class="chip" onclick="setFilter('Elestral', this)">Elestrals</div>
                <div class="chip" onclick="setFilter('Spirit', this)">Spirits</div>
                <div class="chip" onclick="setFilter('Spell', this)">Spells</div>
            </div>
        </div>
        <div id="collection-grid" class="grid"></div>
    </div>

    <div id="detail-view">
        <span onclick="closeDetail()" style="float:right; font-size:2.5rem; color:var(--gold); cursor:pointer;">&times;</span>
        <img id="dt-img" class="detail-img" src="">
        <h2 id="dt-name" style="text-align:center;"></h2>
        <p id="dt-stats" style="text-align:center; color:var(--gold);"></p>
        <button onclick="closeDetail()" style="width:100%; padding:15px; background:#444; color:white; border:none; border-radius:8px;">BACK</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCSLj634AKyrwrDE1FPcXTsePPuiiYBFKQ", projectId: "elestralcardscanner", appId: "1:50825995351:web:8a8abde8c256fca22cef12" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const USER_ID = "DeathTone";

        let vaultData = [];
        let currentFilter = 'All';

        // --- NAVIGATION & FILTERS ---
        window.showView = (v) => {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('nav span').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${v}`).classList.add('active');
            document.getElementById(`nav-${v}`).classList.add('active');
        };

        window.setFilter = (type, el) => {
            currentFilter = type;
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            renderVault();
        };

        // --- MOCK SCAN ---
        window.mockScan = async () => {
            const id = "BT01-001";
            await setDoc(doc(db, "users", USER_ID, "collection", id), {
                id, name: "Adrestia", type: "Elestral", price: 15.40,
                img: `https://collect.elestrals.com/assets/cards/${id}.png`,
                quantity: increment(1)
            }, { merge: true });
            alert("Adrestia added!");
        };

        // --- EVENT DELEGATION FOR CLICKS ---
        const grid = document.getElementById('collection-grid');
        grid.addEventListener('click', (e) => {
            const cardElement = e.target.closest('.card-item');
            if (cardElement) {
                const cardId = cardElement.getAttribute('data-id');
                const card = vaultData.find(c => c.id === cardId);
                if (card) openDetail(card);
            }
        });

        window.openDetail = (card) => {
            document.getElementById('dt-img').src = card.img;
            document.getElementById('dt-name').innerText = card.name;
            document.getElementById('dt-stats').innerText = `$${(card.price || 0).toFixed(2)} | Owned: ${card.quantity}`;
            document.getElementById('detail-view').style.display = "block";
        };

        window.closeDetail = () => { document.getElementById('detail-view').style.display = "none"; };

        // --- RENDER LOGIC ---
        onSnapshot(collection(db, "users", USER_ID, "collection"), (snap) => {
            vaultData = [];
            snap.forEach(d => vaultData.push(d.data()));
            renderVault();
        });

        window.renderVault = () => {
            const search = document.getElementById('search').value.toLowerCase();
            grid.innerHTML = vaultData
                .filter(c => c.name.toLowerCase().includes(search) && (currentFilter === 'All' || c.type === currentFilter))
                .map(c => `
                    <div class="card-item" data-id="${c.id}">
                        <img src="${c.img}">
                        <div style="font-size:0.75rem; margin-top:5px; color:var(--gold); font-weight:bold;">${c.name}</div>
                        <div style="font-size:0.6rem;">x${c.quantity}</div>
                    </div>
                `).join('');
        };
    </script>
</body>
</html>
